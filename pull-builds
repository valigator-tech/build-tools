#!/usr/bin/env bash
set -euo pipefail

# pull-builds - Pull and install artifacts from artifact server
#
# Usage:
#   pull-builds list              # List all available apps
#   pull-builds <app> list        # List all versions for an app
#   pull-builds <app> <version>   # Pull and install a specific version

# Configuration
# Priority: 1) ARTIFACT_SERVER env var already set, 2) ~/.env, 3) default
if [[ -z "${ARTIFACT_SERVER:-}" ]]; then
  # Try to source ~/.env
  if [[ -f "$HOME/.env" ]]; then
    source "$HOME/.env"
  fi

  # Fall back to default if still not set
  if [[ -z "${ARTIFACT_SERVER:-}" ]]; then
    ARTIFACT_SERVER="http://localhost:8080"
  fi
fi

BASE_DIR="/home/sol/releases"

# Agave fork app names (used internally for artifact paths)
AGAVE_FORKS="agave bam-client jito-solana harmonic"

# Color output (if terminal supports it)
if [[ -t 1 ]]; then
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  RED='\033[0;31m'
  BLUE='\033[0;34m'
  NC='\033[0m' # No Color
else
  GREEN=''
  YELLOW=''
  RED=''
  BLUE=''
  NC=''
fi

usage() {
  cat <<EOF
Usage: pull-builds [COMMAND] [OPTIONS]

Commands:
  list                    List all available apps
  <app> list             List all versions for a specific app
  <app> <version>        Pull and install a specific version

Supported Apps:
  agave                   Solana validator (includes all forks)
  ha                      Solana Validator HA
  svf                     Solana Validator Failover

Agave Forks (auto-detected from version tag):
  v3.0.10                 Vanilla Agave
  v3.0.10-jito            Jito Solana
  v3.0.10-bam*            BAM Client
  v3.0.10-harmonic        Harmonic

Examples:
  pull-builds list
  pull-builds agave list
  pull-builds agave v3.0.10
  pull-builds agave v3.0.10-jito
  pull-builds ha v0.1.7
  pull-builds svf v0.1.12

Environment Variables:
  ARTIFACT_SERVER        URL of artifact server (default: http://localhost:8080)

EOF
  exit 1
}

# Detect agave fork from version tag
detect_agave_fork() {
  local version="$1"

  if [[ "$version" == *"bam"* ]]; then
    echo "bam-client"
  elif [[ "$version" == *"jito"* ]]; then
    echo "jito-solana"
  elif [[ "$version" == *"harmonic"* ]]; then
    echo "harmonic"
  elif [[ $version =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "agave"
  else
    echo ""
  fi
}

fetch_index() {
  local index_url="$ARTIFACT_SERVER/index.json"
  local index_file
  index_file=$(mktemp)

  if ! curl -f -s "$index_url" -o "$index_file" 2>/dev/null; then
    echo -e "${RED}ERROR: Failed to fetch index from $index_url${NC}" >&2
    echo "Make sure the artifact server is running and accessible." >&2
    rm -f "$index_file"
    exit 1
  fi

  echo "$index_file"
}

list_apps() {
  echo "Fetching available apps from $ARTIFACT_SERVER..."
  echo ""

  local index_file
  index_file=$(fetch_index)

  echo "Available apps:"
  echo "==============="

  # Only show the three main app types
  for app in agave ha svf; do
    if [[ "$app" == "agave" ]]; then
      # Check if any agave fork has versions
      local has_versions=false
      for fork in $AGAVE_FORKS; do
        if grep -q "\"$fork\":" "$index_file" 2>/dev/null; then
          has_versions=true
          break
        fi
      done
      if [[ "$has_versions" == true ]]; then
        echo "  • agave"
      fi
    else
      if grep -q "\"$app\":" "$index_file" 2>/dev/null; then
        echo "  • $app"
      fi
    fi
  done

  rm -f "$index_file"
  echo ""
  echo "To list versions: pull-builds <app> list"
}

list_versions() {
  local app="$1"
  echo "Fetching available versions for '$app' from $ARTIFACT_SERVER..."
  echo ""

  local index_file
  index_file=$(fetch_index)

  if [[ "$app" == "agave" ]]; then
    # Aggregate versions from all agave forks
    echo "Available versions for 'agave' (all forks):"
    echo "============================================="

    local found_any=false

    for fork in $AGAVE_FORKS; do
      local versions
      versions=$(grep -o "\"$fork\": \[.*\]" "$index_file" | sed 's/.*\[//; s/\].*//; s/"//g; s/,/\n/g' | tr -d ' ' | grep -v '^$' || true)

      if [[ -n "$versions" ]]; then
        found_any=true
        echo ""
        echo "[$fork]"

        # Check installed versions for this fork
        local installed_dir="$BASE_DIR/$fork"

        while IFS= read -r version; do
          if [[ -d "$installed_dir/$version" ]]; then
            echo -e "  ${GREEN}✓${NC} $version ${YELLOW}(installed)${NC}"
          else
            echo "  • $version"
          fi
        done <<< "$versions"
      fi
    done

    if [[ "$found_any" == false ]]; then
      echo -e "${RED}ERROR: No agave versions found in artifact server${NC}" >&2
      rm -f "$index_file"
      exit 1
    fi
  else
    # ha or svf - simple version list
    local versions
    versions=$(grep -o "\"$app\": \[.*\]" "$index_file" | sed 's/.*\[//; s/\].*//; s/"//g; s/,/\n/g' | tr -d ' ' | grep -v '^$' || true)

    if [[ -z "$versions" ]]; then
      echo -e "${RED}ERROR: App '$app' not found in artifact server${NC}" >&2
      echo "" >&2
      echo "Available apps: agave, ha, svf" >&2
      rm -f "$index_file"
      exit 1
    fi

    echo "Available versions for '$app':"
    echo "================================"

    local installed_dir="$BASE_DIR/$app"

    while IFS= read -r version; do
      if [[ -d "$installed_dir/$version" ]]; then
        echo -e "  ${GREEN}✓${NC} $version ${YELLOW}(installed)${NC}"
      else
        echo "  • $version"
      fi
    done <<< "$versions"
  fi

  rm -f "$index_file"
  echo ""
  echo "To install: pull-builds $app <version>"
}

pull_version() {
  local app="$1"
  local version="$2"

  # Determine actual app name (for agave, detect fork from version)
  local actual_app="$app"
  if [[ "$app" == "agave" ]]; then
    actual_app=$(detect_agave_fork "$version")
    if [[ -z "$actual_app" ]]; then
      echo -e "${RED}ERROR: Unable to determine agave fork from version '$version'${NC}" >&2
      echo "" >&2
      echo "Expected tag patterns:" >&2
      echo "  v3.0.10          -> vanilla agave" >&2
      echo "  v3.0.10-jito     -> jito-solana" >&2
      echo "  v3.0.10-bam*     -> bam-client" >&2
      echo "  v3.0.10-harmonic -> harmonic" >&2
      exit 1
    fi
    if [[ "$actual_app" != "agave" ]]; then
      echo -e "${BLUE}>>> Detected fork: $actual_app${NC}"
    fi
  fi

  echo -e "${BLUE}>>> Pulling $actual_app $version${NC}"
  echo ""

  # Verify version exists in index
  local index_file
  index_file=$(fetch_index)

  local versions
  versions=$(grep -o "\"$actual_app\": \[.*\]" "$index_file" | sed 's/.*\[//; s/\].*//; s/"//g; s/,/\n/g' | tr -d ' ' | grep -v '^$' || true)

  if [[ -z "$versions" ]]; then
    echo -e "${RED}ERROR: App '$actual_app' not found in artifact server${NC}" >&2
    rm -f "$index_file"
    exit 1
  fi

  if ! echo "$versions" | grep -q "^${version}$"; then
    echo -e "${RED}ERROR: Version '$version' not found for '$actual_app'${NC}" >&2
    echo "" >&2
    echo "Available versions:" >&2
    echo "$versions" | while IFS= read -r v; do
      echo "  • $v" >&2
    done
    rm -f "$index_file"
    exit 1
  fi

  rm -f "$index_file"

  # Check if already installed
  local install_dir="$BASE_DIR/$actual_app/$version"
  if [[ -d "$install_dir" ]]; then
    echo -e "${YELLOW}Version $version is already installed at $install_dir${NC}"
    echo ""
    echo "To reinstall, first remove: rm -rf $install_dir"
    echo ""
    echo -e "${GREEN}To activate this version:${NC}"
    echo "  activate-builds $app $version"
    exit 0
  fi

  # Download tarball
  local tarball_name="$actual_app-$version.tar.gz"
  local tarball_url="$ARTIFACT_SERVER/$actual_app/artifacts/$tarball_name"
  local temp_dir
  temp_dir=$(mktemp -d)
  local tarball_path="$temp_dir/$tarball_name"

  echo "Downloading from: $tarball_url"

  if ! curl -f -L --progress-bar "$tarball_url" -o "$tarball_path"; then
    echo -e "${RED}ERROR: Failed to download $tarball_url${NC}" >&2
    rm -rf "$temp_dir"
    exit 1
  fi

  echo -e "${GREEN}✓ Download complete${NC}"
  echo ""

  # Extract to releases directory
  echo "Installing to: $install_dir"

  mkdir -p "$BASE_DIR/$actual_app"

  if ! tar -xzf "$tarball_path" -C "$BASE_DIR/$actual_app"; then
    echo -e "${RED}ERROR: Failed to extract tarball${NC}" >&2
    rm -rf "$temp_dir"
    exit 1
  fi

  rm -rf "$temp_dir"

  echo -e "${GREEN}✓ Installation complete${NC}"
  echo ""
  echo "=================================="
  echo -e "${GREEN}Successfully installed $actual_app $version${NC}"
  echo "=================================="
  echo ""
  echo "Location: $install_dir"
  echo ""
  echo -e "${BLUE}To activate this version:${NC}"
  echo "  activate-builds $app $version"
  echo ""
}

# Main command parsing
if [[ $# -eq 0 ]]; then
  usage
fi

COMMAND="$1"

case "$COMMAND" in
  list)
    list_apps
    ;;

  -h|--help|help)
    usage
    ;;

  agave|ha|svf)
    APP="$COMMAND"

    if [[ $# -lt 2 ]]; then
      echo -e "${RED}ERROR: Missing command for app '$APP'${NC}" >&2
      echo "" >&2
      usage
    fi

    SUBCOMMAND="$2"

    case "$SUBCOMMAND" in
      list)
        list_versions "$APP"
        ;;

      *)
        # Assume it's a version
        VERSION="$SUBCOMMAND"
        pull_version "$APP" "$VERSION"
        ;;
    esac
    ;;

  *)
    echo -e "${RED}ERROR: Unknown app '$COMMAND'${NC}" >&2
    echo "" >&2
    echo "Available apps: agave, ha, svf" >&2
    echo "" >&2
    echo "Use 'pull-builds list' to see available apps." >&2
    exit 1
    ;;
esac
