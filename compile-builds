#!/usr/bin/env bash
set -euo pipefail

# compile-builds - Unified build script for all app types
#
# Usage:
#   compile-builds list              # List all buildable apps
#   compile-builds agave <tag>       # Build agave variant (auto-detects type from tag)
#   compile-builds ha <tag>          # Download pre-built HA binary
#   compile-builds svf <tag>         # Download pre-built SVF binary

# Get script directory at the start, before any cd commands
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

BASE_DIR="/var/www/build-artifacts"

# Color output (if terminal supports it)
if [[ -t 1 ]]; then
  GREEN='\033[0;32m'
  YELLOW='\033[1;33m'
  RED='\033[0;31m'
  BLUE='\033[0;34m'
  NC='\033[0m' # No Color
else
  GREEN=''
  YELLOW=''
  RED=''
  BLUE=''
  NC=''
fi

usage() {
  cat <<EOF
Usage: compile-builds [COMMAND] [OPTIONS]

Commands:
  list                    List all buildable apps
  <app> <tag>            Build/download a specific version

Options:
  -f, --force             Force update of existing tags (clobber)

Supported Apps:
  agave                   Agave validator (auto-detects variant from tag)
                          - v3.0.10          -> vanilla agave
                          - v3.0.10-jito     -> jito-solana
                          - v3.0.10-bam*     -> bam-client
                          - v3.0.10-harmonic -> harmonic
  ha                      Solana Validator HA (downloads pre-built binary)
  svf                     Solana Validator Failover (downloads pre-built binary)

Examples:
  compile-builds list
  compile-builds agave v3.0.10
  compile-builds agave v3.0.10-jito
  compile-builds ha v0.1.7
  compile-builds svf v0.1.12

EOF
  exit 1
}

list_apps() {
  echo "Buildable applications:"
  echo "======================="
  echo ""
  echo -e "  ${BLUE}agave${NC}      - Agave validator and variants (builds from source)"
  echo "               Variants auto-detected from tag pattern:"
  echo "               - vanilla agave:  v3.0.10"
  echo "               - jito-solana:    v3.0.10-jito"
  echo "               - bam-client:     v3.0.10-bam_patch1"
  echo "               - harmonic:       v3.0.10-harmonic"
  echo ""
  echo -e "  ${BLUE}ha${NC}         - Solana Validator HA (downloads pre-built)"
  echo "               Source: github.com/sol-strategies/solana-validator-ha"
  echo ""
  echo -e "  ${BLUE}svf${NC}        - Solana Validator Failover (downloads pre-built)"
  echo "               Source: github.com/SOL-Strategies/solana-validator-failover"
  echo ""
  echo "Usage: compile-builds <app> <tag>"
}

# Detect app type from agave tag pattern
detect_agave_variant() {
  local tag="$1"

  if [[ "$tag" == *"bam"* ]]; then
    echo "bam-client"
  elif [[ "$tag" == *"jito"* ]]; then
    echo "jito-solana"
  elif [[ "$tag" == *"harmonic"* ]]; then
    echo "harmonic"
  elif [[ $tag =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "agave"
  else
    echo ""
  fi
}

# Get repo URL for agave variant
get_agave_repo_url() {
  local app_name="$1"

  case "$app_name" in
    bam-client)
      echo "https://github.com/jito-labs/bam-client"
      ;;
    jito-solana)
      echo "https://github.com/jito-foundation/jito-solana.git"
      ;;
    harmonic)
      echo "git@github.com:meijilabs/proposer.git"
      ;;
    agave)
      echo "https://github.com/anza-xyz/agave.git"
      ;;
    *)
      echo ""
      ;;
  esac
}

# Build agave or variant from source
build_agave_variant() {
  local tag="$1"

  # Detect app type from tag
  local app_name
  app_name=$(detect_agave_variant "$tag")

  if [[ -z "$app_name" ]]; then
    echo -e "${RED}ERROR: Unable to determine app type from tag '$tag'${NC}" >&2
    echo "" >&2
    echo "Expected tag patterns:" >&2
    echo "  - v3.0.10          -> vanilla agave" >&2
    echo "  - v3.0.10-jito     -> jito-solana" >&2
    echo "  - v3.0.10-bam*     -> bam-client" >&2
    echo "  - v3.0.10-harmonic -> harmonic" >&2
    exit 1
  fi

  local repo_url
  repo_url=$(get_agave_repo_url "$app_name")

  echo -e "${BLUE}>>> Building $app_name from tag $tag${NC}"
  echo ""

  # Directory setup
  local release_root="$BASE_DIR/$app_name/releases"
  local artifact_root="$BASE_DIR/$app_name/artifacts"
  local solana_release_dir="$HOME/.local/share/solana/install/releases/$tag"
  local src_base="$BASE_DIR/src"
  local src_dir="$src_base/$app_name"

  mkdir -p "$src_base" "$release_root" "$artifact_root"

  # Check if this version is already built
  local artifact_path="$artifact_root/$app_name-$tag.tar.gz"
  if [[ -f "$artifact_path" ]]; then
    echo -e "${RED}ERROR: Version $tag already exists at $artifact_path${NC}" >&2
    echo "If you want to rebuild, delete the artifact first." >&2
    exit 1
  fi

  echo ">>> Fetching source for tag $tag"

  if [[ -d "$src_dir/.git" ]]; then
    echo ">>> Repo exists, updating"
    cd "$src_dir"
    git config --global --add safe.directory "$src_dir"
    if [[ "$FORCE" == "true" ]]; then
      git fetch --tags --force origin
    else
      git fetch --tags origin
    fi
  else
    echo ">>> Cloning fresh repo"
    git clone --recurse-submodules "$repo_url" "$src_dir"
    cd "$src_dir"
    git config --global --add safe.directory "$src_dir"
  fi

  # Clean working tree
  git reset --hard
  git clean -fdx

  # Checkout the tag
  git checkout "tags/$tag"
  git submodule update --init --recursive

  # Build
  local ci_commit
  ci_commit=$(git rev-parse HEAD)
  echo ">>> Building at commit $ci_commit"

  CI_COMMIT="$ci_commit" scripts/cargo-install-all.sh --validator-only "$solana_release_dir"

  echo ">>> Build complete, staging release"

  # Stage into versioned directory
  local stage_dir="$release_root/$tag"
  rm -rf "$stage_dir"
  mkdir -p "$stage_dir/bin"

  cp -a "$solana_release_dir"/bin/* "$stage_dir/bin/"

  # Metadata files
  echo "$tag" > "$stage_dir/TAG"
  echo "$ci_commit" > "$stage_dir/COMMIT"
  date -u --iso-8601=seconds > "$stage_dir/BUILT_AT"

  echo ">>> Creating tarball"

  cd "$release_root"
  tar czf "$artifact_root/$app_name-$tag.tar.gz" "$tag"

  echo ""
  echo -e "${GREEN}Done.${NC}"
  echo "Staged directory: $stage_dir"
  echo "Artifact:         $artifact_root/$app_name-$tag.tar.gz"

  # Update artifact index
  update_index
}

# Download pre-built HA binary from GitHub releases
build_ha() {
  local tag="$1"
  local app_name="ha"
  local github_repo="sol-strategies/solana-validator-ha"

  echo -e "${BLUE}>>> Downloading HA release $tag${NC}"
  echo ""

  local release_root="$BASE_DIR/$app_name/releases"
  local artifact_root="$BASE_DIR/$app_name/artifacts"
  local download_dir="$BASE_DIR/$app_name/downloads"

  mkdir -p "$release_root" "$artifact_root" "$download_dir"

  # Check if already built
  local artifact_path="$artifact_root/$app_name-$tag.tar.gz"
  if [[ -f "$artifact_path" ]]; then
    echo -e "${RED}ERROR: Version $tag already exists at $artifact_path${NC}" >&2
    echo "If you want to rebuild, delete the artifact first." >&2
    exit 1
  fi

  # Strip 'v' prefix for download URL construction
  local version="${tag#v}"

  # Check if release exists
  echo ">>> Checking if release $tag exists..."
  local release_info
  release_info=$(curl -s "https://api.github.com/repos/${github_repo}/releases/tags/${tag}")

  if echo "$release_info" | grep -q '"message": "Not Found"'; then
    echo -e "${RED}ERROR: Release $tag not found in repository $github_repo${NC}" >&2
    echo "" >&2
    echo "Available releases:" >&2
    curl -s "https://api.github.com/repos/${github_repo}/releases" | grep '"tag_name"' | cut -d'"' -f4 | head -10 >&2
    exit 1
  fi

  echo -e "${GREEN}✓ Release $tag exists${NC}"

  # Construct expected filenames
  local binary_filename="solana-validator-ha-${version}-linux-amd64.gz"
  local checksum_filename="solana-validator-ha-${version}-linux-amd64.gz.sha256"

  # Verify assets exist
  echo ">>> Verifying required assets exist..."
  local assets
  assets=$(echo "$release_info" | grep '"name"' | cut -d'"' -f4)

  if ! echo "$assets" | grep -q "^${binary_filename}$"; then
    echo -e "${RED}ERROR: Binary asset not found: $binary_filename${NC}" >&2
    echo "" >&2
    echo "Available assets for $tag:" >&2
    echo "$assets" >&2
    exit 1
  fi

  if ! echo "$assets" | grep -q "^${checksum_filename}$"; then
    echo -e "${RED}ERROR: Checksum asset not found: $checksum_filename${NC}" >&2
    echo "" >&2
    echo "Available assets for $tag:" >&2
    echo "$assets" >&2
    exit 1
  fi

  echo -e "${GREEN}✓ Required assets found${NC}"

  # Download URLs
  local binary_url="https://github.com/${github_repo}/releases/download/${tag}/${binary_filename}"
  local checksum_url="https://github.com/${github_repo}/releases/download/${tag}/${checksum_filename}"

  echo ">>> Downloading release $tag for linux-amd64"

  cd "$download_dir"

  echo ">>> Downloading binary..."
  if ! curl -f -L -o "$binary_filename" "$binary_url"; then
    echo -e "${RED}ERROR: Failed to download binary from $binary_url${NC}" >&2
    exit 1
  fi

  # Verify gzip format
  if ! file "$binary_filename" | grep -q "gzip compressed"; then
    echo -e "${RED}ERROR: Downloaded file is not in gzip format${NC}" >&2
    echo "File type: $(file "$binary_filename")" >&2
    exit 1
  fi

  echo ">>> Downloading checksum..."
  if ! curl -f -L -o "$checksum_filename" "$checksum_url"; then
    echo -e "${RED}ERROR: Failed to download checksum from $checksum_url${NC}" >&2
    exit 1
  fi

  # Verify checksum
  echo ">>> Verifying checksum..."
  local expected_hash actual_hash
  expected_hash=$(cut -d' ' -f1 "$checksum_filename")
  actual_hash=$(sha256sum "$binary_filename" | cut -d' ' -f1)

  if [[ "$expected_hash" == "$actual_hash" ]]; then
    echo -e "${GREEN}✓ Checksum verification passed${NC}"
  else
    echo -e "${RED}ERROR: Checksum verification failed!${NC}" >&2
    echo "  Expected: $expected_hash" >&2
    echo "  Actual:   $actual_hash" >&2
    exit 1
  fi

  # Extract binary
  echo ">>> Extracting binary..."
  gunzip -f "$binary_filename"

  local extracted_binary="solana-validator-ha-${version}-linux-amd64"

  if [[ ! -f "$extracted_binary" ]]; then
    echo -e "${RED}ERROR: Expected binary not found: $extracted_binary${NC}" >&2
    exit 1
  fi

  # Stage release
  echo ">>> Staging release"
  local stage_dir="$release_root/$tag"
  rm -rf "$stage_dir"
  mkdir -p "$stage_dir/bin"

  cp "$extracted_binary" "$stage_dir/bin/solana-validator-ha"
  chmod +x "$stage_dir/bin/solana-validator-ha"

  # Get commit hash (best effort)
  local ci_commit
  ci_commit=$(curl -s "https://api.github.com/repos/${github_repo}/git/ref/tags/${tag}" | grep -o '"sha": "[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")

  # Metadata files
  echo "$tag" > "$stage_dir/TAG"
  echo "$ci_commit" > "$stage_dir/COMMIT"
  date -u --iso-8601=seconds > "$stage_dir/BUILT_AT"

  echo ">>> Creating tarball"

  cd "$release_root"
  tar czf "$artifact_root/$app_name-$tag.tar.gz" "$tag"

  echo ""
  echo -e "${GREEN}Done.${NC}"
  echo "Staged directory: $stage_dir"
  echo "Artifact:         $artifact_root/$app_name-$tag.tar.gz"

  # Update artifact index
  update_index
}

# Download pre-built SVF binary from GitHub releases
build_svf() {
  local tag="$1"
  local app_name="svf"
  local github_repo="SOL-Strategies/solana-validator-failover"

  echo -e "${BLUE}>>> Downloading SVF release $tag${NC}"
  echo ""

  local release_root="$BASE_DIR/$app_name/releases"
  local artifact_root="$BASE_DIR/$app_name/artifacts"
  local download_dir="$BASE_DIR/$app_name/downloads"

  mkdir -p "$release_root" "$artifact_root" "$download_dir"

  # Check if already built
  local artifact_path="$artifact_root/$app_name-$tag.tar.gz"
  if [[ -f "$artifact_path" ]]; then
    echo -e "${RED}ERROR: Version $tag already exists at $artifact_path${NC}" >&2
    echo "If you want to rebuild, delete the artifact first." >&2
    exit 1
  fi

  # Strip 'v' prefix for download URL construction
  local version="${tag#v}"

  # Check if release exists
  echo ">>> Checking if release $tag exists..."
  local release_info
  release_info=$(curl -s "https://api.github.com/repos/${github_repo}/releases/tags/${tag}")

  if echo "$release_info" | grep -q '"message": "Not Found"'; then
    echo -e "${RED}ERROR: Release $tag not found in repository $github_repo${NC}" >&2
    echo "" >&2
    echo "Available releases:" >&2
    curl -s "https://api.github.com/repos/${github_repo}/releases" | grep '"tag_name"' | cut -d'"' -f4 | head -10 >&2
    exit 1
  fi

  echo -e "${GREEN}✓ Release $tag exists${NC}"

  # Construct expected filenames
  local binary_filename="solana-validator-failover-${version}-linux-amd64.gz"
  local checksum_filename="solana-validator-failover-${version}-linux-amd64.sha256"

  # Verify assets exist
  echo ">>> Verifying required assets exist..."
  local assets
  assets=$(echo "$release_info" | grep '"name"' | cut -d'"' -f4)

  if ! echo "$assets" | grep -q "^${binary_filename}$"; then
    echo -e "${RED}ERROR: Binary asset not found: $binary_filename${NC}" >&2
    echo "" >&2
    echo "Available assets for $tag:" >&2
    echo "$assets" >&2
    exit 1
  fi

  if ! echo "$assets" | grep -q "^${checksum_filename}$"; then
    echo -e "${RED}ERROR: Checksum asset not found: $checksum_filename${NC}" >&2
    echo "" >&2
    echo "Available assets for $tag:" >&2
    echo "$assets" >&2
    exit 1
  fi

  echo -e "${GREEN}✓ Required assets found${NC}"

  # Download URLs
  local binary_url="https://github.com/${github_repo}/releases/download/${tag}/${binary_filename}"
  local checksum_url="https://github.com/${github_repo}/releases/download/${tag}/${checksum_filename}"

  echo ">>> Downloading release $tag for linux-amd64"

  cd "$download_dir"

  echo ">>> Downloading binary..."
  if ! curl -f -L -o "$binary_filename" "$binary_url"; then
    echo -e "${RED}ERROR: Failed to download binary from $binary_url${NC}" >&2
    exit 1
  fi

  # Verify gzip format
  if ! file "$binary_filename" | grep -q "gzip compressed"; then
    echo -e "${RED}ERROR: Downloaded file is not in gzip format${NC}" >&2
    echo "File type: $(file "$binary_filename")" >&2
    exit 1
  fi

  echo ">>> Downloading checksum..."
  if ! curl -f -L -o "$checksum_filename" "$checksum_url"; then
    echo -e "${RED}ERROR: Failed to download checksum from $checksum_url${NC}" >&2
    exit 1
  fi

  # Extract binary first (SVF checksum is for extracted binary)
  echo ">>> Extracting binary..."
  gunzip -f "$binary_filename"

  local extracted_binary="solana-validator-failover-${version}-linux-amd64"

  if [[ ! -f "$extracted_binary" ]]; then
    echo -e "${RED}ERROR: Expected binary not found: $extracted_binary${NC}" >&2
    exit 1
  fi

  # Verify checksum (SVF checksums the extracted binary)
  echo ">>> Verifying checksum..."
  local expected_hash actual_hash
  expected_hash=$(cut -d' ' -f1 "$checksum_filename")
  actual_hash=$(sha256sum "$extracted_binary" | cut -d' ' -f1)

  if [[ "$expected_hash" == "$actual_hash" ]]; then
    echo -e "${GREEN}✓ Checksum verification passed${NC}"
  else
    echo -e "${RED}ERROR: Checksum verification failed!${NC}" >&2
    echo "  Expected: $expected_hash" >&2
    echo "  Actual:   $actual_hash" >&2
    exit 1
  fi

  # Stage release
  echo ">>> Staging release"
  local stage_dir="$release_root/$tag"
  rm -rf "$stage_dir"
  mkdir -p "$stage_dir/bin"

  cp "$extracted_binary" "$stage_dir/bin/solana-validator-failover"
  chmod +x "$stage_dir/bin/solana-validator-failover"

  # Get commit hash (best effort)
  local ci_commit
  ci_commit=$(curl -s "https://api.github.com/repos/${github_repo}/git/ref/tags/${tag}" | grep -o '"sha": "[^"]*"' | head -1 | cut -d'"' -f4 || echo "unknown")

  # Metadata files
  echo "$tag" > "$stage_dir/TAG"
  echo "$ci_commit" > "$stage_dir/COMMIT"
  date -u --iso-8601=seconds > "$stage_dir/BUILT_AT"

  echo ">>> Creating tarball"

  cd "$release_root"
  tar czf "$artifact_root/$app_name-$tag.tar.gz" "$tag"

  echo ""
  echo -e "${GREEN}Done.${NC}"
  echo "Staged directory: $stage_dir"
  echo "Artifact:         $artifact_root/$app_name-$tag.tar.gz"

  # Update artifact index
  update_index
}

# Update the artifact index
update_index() {
  echo ">>> Updating artifact index..."
  if [[ -x "$SCRIPT_DIR/generate-index.sh" ]]; then
    "$SCRIPT_DIR/generate-index.sh" || echo -e "${YELLOW}Warning: Failed to update index${NC}"
  else
    echo -e "${RED}ERROR: generate-index.sh not found or not executable at $SCRIPT_DIR/generate-index.sh${NC}" >&2
  fi
}

# Parse global options
FORCE=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -f|--force)
      FORCE=true
      shift
      ;;
    *)
      break
      ;;
  esac
done

# Main command parsing
if [[ $# -eq 0 ]]; then
  usage
fi

COMMAND="$1"

case "$COMMAND" in
  list)
    list_apps
    ;;

  -h|--help|help)
    usage
    ;;

  agave)
    if [[ $# -lt 2 ]]; then
      echo -e "${RED}ERROR: Missing tag for agave build${NC}" >&2
      echo "" >&2
      echo "Usage: compile-builds agave <tag>" >&2
      echo "" >&2
      echo "Examples:" >&2
      echo "  compile-builds agave v3.0.10" >&2
      echo "  compile-builds agave v3.0.10-jito" >&2
      exit 1
    fi
    build_agave_variant "$2"
    ;;

  ha)
    if [[ $# -lt 2 ]]; then
      echo -e "${RED}ERROR: Missing tag for HA build${NC}" >&2
      echo "" >&2
      echo "Usage: compile-builds ha <tag>" >&2
      echo "Example: compile-builds ha v0.1.7" >&2
      exit 1
    fi
    build_ha "$2"
    ;;

  svf)
    if [[ $# -lt 2 ]]; then
      echo -e "${RED}ERROR: Missing tag for SVF build${NC}" >&2
      echo "" >&2
      echo "Usage: compile-builds svf <tag>" >&2
      echo "Example: compile-builds svf v0.1.12" >&2
      exit 1
    fi
    build_svf "$2"
    ;;

  *)
    echo -e "${RED}ERROR: Unknown app '$COMMAND'${NC}" >&2
    echo "" >&2
    echo "Available apps: agave, ha, svf" >&2
    echo "" >&2
    echo "Use 'compile-builds list' to see all options." >&2
    exit 1
    ;;
esac
